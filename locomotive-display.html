<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Safety Monitor - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-opacity {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.35; }
        }
        .pulse-zone {
            animation: pulse-opacity 2s ease-in-out infinite;
        }
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .flash-critical {
            animation: flash 0.5s ease-in-out infinite;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Video styles */
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0a0a0a;
        }
        
        .video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .zoom-video {
            transform: scale(2.5);
            transform-origin: center center;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans m-0 p-0 overflow-hidden">
    <div class="min-h-screen p-4">
        <div class="max-w-screen-2xl mx-auto">
            <!-- Main Grid Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 h-screen max-h-screen">
                
                <!-- Left Panel - Primary Camera View -->
                <div class="lg:col-span-3 flex flex-col">
                    <div class="bg-gray-800 rounded border border-white border-opacity-10 flex-1 flex flex-col overflow-hidden shadow-2xl">
                        <!-- Header with Camera Controls -->
                        <div class="px-4 py-3 border-b border-white border-opacity-10 flex justify-between items-center">
                            <h2 class="text-xs uppercase tracking-wider text-gray-400 font-semibold">Primary Camera View</h2>
                            <div class="flex gap-2 items-center">
                                <span id="cameraStatus" class="text-xs px-2 py-1 bg-red-500 rounded">Camera Off</span>
                                <button id="toggleCamera" class="text-xs px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded transition">
                                    Start Camera
                                </button>
                            </div>
                        </div>
                        
                        <!-- Camera Viewport with Live Feed -->
                        <div class="flex-1 relative video-container">
                            <!-- Live video stream from backend -->
                            <img id="primaryVideo" class="video-feed" src="" alt="Camera feed">
                            
                            <!-- SVG Overlay for wireframes -->
                            <svg class="video-overlay" viewBox="0 0 1920 1080" preserveAspectRatio="xMidYMid slice">
                                <defs>
                                    <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                                        <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>
                                    </pattern>
                                </defs>
                                
                                <!-- Grid overlay -->
                                <rect width="1920" height="1080" fill="url(#grid)" opacity="0.2" />
                                
                                <!-- Center crosshair -->
                                <line x1="960" y1="520" x2="960" y2="560" stroke="rgba(255,255,255,0.5)" stroke-width="2" />
                                <line x1="940" y1="540" x2="980" y2="540" stroke="rgba(255,255,255,0.5)" stroke-width="2" />
                                
                                <!-- Detection zone trapezoid (wireframe) -->
                                <polygon id="detectionZone"
                                    points="600,1080 1320,1080 1100,400 820,400"
                                    fill="#E53935"
                                    fill-opacity="0.1"
                                    stroke="#E53935"
                                    stroke-width="3"
                                    stroke-dasharray="10,5"
                                    class="pulse-zone"
                                />
                                
                                <!-- Distance markers -->
                                <text x="960" y="900" text-anchor="middle" fill="white" font-size="16" opacity="0.7">50m</text>
                                <text x="960" y="700" text-anchor="middle" fill="white" font-size="16" opacity="0.7">100m</text>
                                <text x="960" y="500" text-anchor="middle" fill="white" font-size="16" opacity="0.7">150m</text>
                                
                                <!-- Ego path label -->
                                <text x="960" y="1050" text-anchor="middle" fill="white" font-size="18" font-weight="bold">
                                    EGO PATH
                                </text>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Right Panel -->
                <div class="lg:col-span-2 flex flex-col gap-4">
                    
                    <!-- Secondary Zoom View -->
                    <div class="bg-gray-800 rounded border border-white border-opacity-10 shadow-2xl">
                        <div class="px-4 py-3 border-b border-white border-opacity-10">
                            <h2 class="text-xs uppercase tracking-wider text-gray-400 font-semibold">Secondary Zoom View (2.5x)</h2>
                        </div>
                        <div class="relative bg-gray-950 h-48 overflow-hidden">
                            <!-- Zoomed video feed (same source, scaled) -->
                            <img id="secondaryVideo" class="video-feed zoom-video" src="" alt="Zoomed view">
                            
                            <!-- Zoom overlay -->
                            <svg class="video-overlay" viewBox="0 0 1920 1080" preserveAspectRatio="xMidYMid slice">
                                <circle cx="960" cy="540" r="100" fill="none" stroke="#E53935" stroke-width="3" opacity="0.6" />
                                <text x="960" y="680" text-anchor="middle" fill="#E53935" font-size="20" font-weight="bold">
                                    ZOOM FOCUS
                                </text>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Hazard Summary Panel -->
                    <div class="bg-gray-800 rounded border border-white border-opacity-10 flex-1 flex flex-col overflow-hidden shadow-2xl">
                        <div class="px-4 py-3 border-b border-white border-opacity-10">
                            <h2 class="text-xs uppercase tracking-wider text-gray-400 font-semibold">Hazard Summary Panel</h2>
                        </div>
                        
                        <div class="p-6 flex-1 overflow-auto custom-scrollbar">
                            <!-- Obstacle Info -->
                            <div class="flex items-center gap-4 mb-6">
                                <div id="obstacleIcon" class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm mb-1" id="obstacleStatus">No obstacles detected</p>
                                    <p id="distanceDisplay" class="text-6xl font-bold text-green-500 transition-colors duration-300">
                                        -- m
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Metrics Row -->
                            <div class="grid grid-cols-2 gap-4 mb-6 pb-6 border-b border-white border-opacity-10">
                                <div>
                                    <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Impact Time</p>
                                    <p id="impactTime" class="text-3xl font-bold text-gray-500 font-mono">
                                        --:--
                                    </p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Speed</p>
                                    <p class="text-3xl font-bold text-white">
                                        <span id="speedDisplay">0</span> <span class="text-lg">km/h</span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Detection Stats -->
                            <div class="mb-6 pb-6 border-b border-white border-opacity-10">
                                <h3 class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-3">Detection Statistics</h3>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div class="bg-gray-900 bg-opacity-50 p-2 rounded">
                                        <p class="text-gray-500 text-xs">Objects Detected</p>
                                        <p id="objectCount" class="text-xl font-bold text-white">0</p>
                                    </div>
                                    <div class="bg-gray-900 bg-opacity-50 p-2 rounded">
                                        <p class="text-gray-500 text-xs">Track Coverage</p>
                                        <p id="trackCoverage" class="text-xl font-bold text-white">--</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notifications Section -->
                            <div>
                                <h3 class="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-4">Notifications Section</h3>
                                <div id="notificationsList" class="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
                                    <div class="flex items-start gap-3 p-3 bg-gray-900 bg-opacity-50 rounded">
                                        <svg class="w-4 h-4 text-blue-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-xs font-mono text-gray-400" id="initTime">--:--:--</p>
                                            <p class="text-sm text-gray-200 mt-0.5">System initialized - click Start Camera</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- System Time -->
                            <div class="mt-6 pt-6 border-t border-white border-opacity-10">
                                <p id="systemTime" class="text-xs text-gray-500 text-center font-mono">
                                    System Time: --:--:--
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const BACKEND_URL = 'http://localhost:5000';
        let cameraActive = false;
        let currentSpeed = 0;
        let detectionInterval = null;
        let notifications = [];

        // ==========================================
        // CAMERA CONTROL
        // ==========================================
        document.getElementById('toggleCamera').addEventListener('click', async () => {
            if (!cameraActive) {
                await startCamera();
            } else {
                await stopCamera();
            }
        });

        async function startCamera() {
            try {
                const response = await fetch(`${BACKEND_URL}/start_camera`);
                const data = await response.json();
                
                if (data.status === 'success' || data.status === 'info') {
                    cameraActive = true;
                    document.getElementById('cameraStatus').textContent = 'Camera Active';
                    document.getElementById('cameraStatus').className = 'text-xs px-2 py-1 bg-green-500 rounded';
                    document.getElementById('toggleCamera').textContent = 'Stop Camera';
                    
                    // Start video feed
                    document.getElementById('primaryVideo').src = `${BACKEND_URL}/video_feed?${Date.now()}`;
                    document.getElementById('secondaryVideo').src = `${BACKEND_URL}/video_feed?${Date.now()}`;
                    
                    // Start polling for detections
                    startDetectionPolling();
                    addNotification('success', 'Camera system activated - live detection running');
                }
            } catch (error) {
                console.error('Failed to start camera:', error);
                addNotification('warning', 'Failed to connect to backend. Is web_integration.py running?');
            }
        }

        async function stopCamera() {
            try {
                const response = await fetch(`${BACKEND_URL}/stop_camera`);
                const data = await response.json();
                
                cameraActive = false;
                document.getElementById('cameraStatus').textContent = 'Camera Off';
                document.getElementById('cameraStatus').className = 'text-xs px-2 py-1 bg-red-500 rounded';
                document.getElementById('toggleCamera').textContent = 'Start Camera';
                document.getElementById('primaryVideo').src = '';
                document.getElementById('secondaryVideo').src = '';
                
                stopDetectionPolling();
                resetUI();
                addNotification('info', 'Camera system deactivated');
            } catch (error) {
                console.error('Failed to stop camera:', error);
            }
        }

        // ==========================================
        // DETECTION POLLING
        // ==========================================
        function startDetectionPolling() {
            detectionInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/detections`);
                    const data = await response.json();
                    updateUI(data);
                } catch (error) {
                    console.error('Failed to fetch detections:', error);
                }
            }, 100); // 10 FPS update rate
        }

        function stopDetectionPolling() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
        }

        // ==========================================
        // UI UPDATE FROM BACKEND DATA
        // ==========================================
        function updateUI(data) {
            const { objects, track_coverage, speed } = data;
            
            // Update stats
            document.getElementById('objectCount').textContent = objects.length;
            document.getElementById('trackCoverage').textContent = `${track_coverage.toFixed(1)}%`;
            
            currentSpeed = speed || 0;
            document.getElementById('speedDisplay').textContent = currentSpeed;
            
            // Find closest object
            let closest = null;
            let minDist = Infinity;
            
            objects.forEach(obj => {
                if (obj.distance < minDist) {
                    minDist = obj.distance;
                    closest = obj;
                }
            });
            
            if (closest) {
                updateHazardPanel(closest);
            } else {
                resetHazardPanel();
            }
        }

        function updateHazardPanel(obj) {
            const distance = Math.round(obj.distance);
            
            // Update status text
            document.getElementById('obstacleStatus').textContent = `${obj.class} detected in`;
            
            // Update distance display
            const distEl = document.getElementById('distanceDisplay');
            distEl.textContent = `${distance} m`;
            
            // Color coding based on distance
            if (distance > 100) {
                distEl.className = 'text-6xl font-bold text-green-500 transition-colors duration-300';
            } else if (distance > 50) {
                distEl.className = 'text-6xl font-bold text-yellow-500 transition-colors duration-300';
            } else {
                distEl.className = 'text-6xl font-bold text-red-500 transition-colors duration-300';
            }
            
            // Update icon to red (danger)
            const iconEl = document.getElementById('obstacleIcon');
            iconEl.className = 'w-16 h-16 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg';
            
            // Calculate and display impact time
            if (currentSpeed > 0) {
                const hours = distance / (currentSpeed * 1000);
                const seconds = Math.floor(hours * 3600);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                const timeStr = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                
                const impactEl = document.getElementById('impactTime');
                impactEl.textContent = timeStr;
                impactEl.className = seconds < 5 ? 
                    'text-3xl font-bold text-red-500 font-mono flash-critical' : 
                    'text-3xl font-bold text-red-500 font-mono';
            }
        }

        function resetHazardPanel() {
            document.getElementById('obstacleIcon').className = 'w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg';
            document.getElementById('obstacleStatus').textContent = 'No obstacles detected';
            document.getElementById('distanceDisplay').textContent = '-- m';
            document.getElementById('distanceDisplay').className = 'text-6xl font-bold text-green-500 transition-colors duration-300';
            document.getElementById('impactTime').textContent = '--:--';
            document.getElementById('impactTime').className = 'text-3xl font-bold text-gray-500 font-mono';
        }

        function resetUI() {
            document.getElementById('objectCount').textContent = '0';
            document.getElementById('trackCoverage').textContent = '--';
            document.getElementById('speedDisplay').textContent = '0';
            resetHazardPanel();
        }

        // ==========================================
        // NOTIFICATIONS
        // ==========================================
        function addNotification(type, message) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            const icons = {
                success: '<svg class="w-4 h-4 text-green-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                warning: '<svg class="w-4 h-4 text-yellow-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
                info: '<svg class="w-4 h-4 text-blue-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            };
            
            const html = `
                <div class="flex items-start gap-3 p-3 bg-gray-900 bg-opacity-50 rounded hover:bg-opacity-70 transition-colors">
                    ${icons[type]}
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-mono text-gray-400">${timeStr}</p>
                        <p class="text-sm text-gray-200 mt-0.5">${message}</p>
                    </div>
                </div>
            `;
            
            const list = document.getElementById('notificationsList');
            list.insertAdjacentHTML('afterbegin', html);
            
            // Keep only last 10 notifications
            while (list.children.length > 10) {
                list.removeChild(list.lastChild);
            }
        }

        // ==========================================
        // SYSTEM TIME
        // ==========================================
        setInterval(() => {
            const now = new Date();
            document.getElementById('systemTime').textContent = `System Time: ${now.toLocaleTimeString()}`;
            document.getElementById('initTime').textContent = now.toLocaleTimeString();
        }, 1000);

        // ==========================================
        // INITIALIZATION
        // ==========================================
        console.log('üöÇ Railway Safety Monitor UI Ready');
        console.log('üì° Backend URL:', BACKEND_URL);
        console.log('üîå Make sure web_integration.py is running!');
        
        // Check backend health on load
        fetch(`${BACKEND_URL}/health`)
            .then(res => res.json())
            .then(data => {
                console.log('‚úÖ Backend connected:', data);
                addNotification('success', 'Connected to detection backend');
            })
            .catch(err => {
                console.error('‚ùå Backend not reachable:', err);
                addNotification('warning', 'Backend not reachable. Start web_integration.py');
            });
    </script>
</body>
</html>